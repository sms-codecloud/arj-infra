pipeline {
  agent { label 'win-agent-1' }
  options { disableConcurrentBuilds() }
  environment { TF_IN_AUTOMATION = "true" }

  parameters {
    choice(
      name: 'TF_ACTION',
      choices: ['APPLY', 'DESTROY'],
      description: 'Choose whether to apply or destroy Terraform.'
    )
  }

  stages {
    stage('Checkout Repo') {
      steps {
        cleanWs()
        bat 'git --version'
        dir("${env.WORKSPACE}\\arj-infra") {
          bat 'git clone -b main https://github.com/sms-codecloud/arj-infra.git .'
        }
      }
    }

    stage('Terraform Init & Run') {
    steps {
      withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_secrets_shankar']]) {
        withEnv(["PATH=C:\\binaries\\terraform;${env.PATH}"]) {
          dir("${env.WORKSPACE}\\arj-infra\\s3") {
            powershell '''
              $ErrorActionPreference = "Stop"

              Write-Host "Selected action: $env:TF_ACTION"
              terraform version

              # Init (add -upgrade/-reconfigure if you want)
              terraform init -no-color

              switch ($env:TF_ACTION) {
                'DESTROY' {
                  Write-Host "Running plan (destroy)..."
                  terraform plan -var-file="sample.tfvars" -auto-approve -input=false -no-color
                  Write-Host "Destroying..."
                  terraform destroy -var-file="sample.tfvars" -auto-approve -input=false -no-color
                }
                'APPLY' {
                  Write-Host "Running plan (apply)..."
                  terraform plan -var-file="sample.tfvars" -auto-approve -input=false -no-color
                  Write-Host "Applying..."
                  terraform apply -var-file="sample.tfvars" -auto-approve -input=false -no-color
                }
                default {
                  throw "Unsupported TF_ACTION: '$($env:TF_ACTION)'. Expected 'APPLY' or 'DESTROY'."
                }
              }
            '''
          }
        }
      }
    }
}

  }

  post {
    always {
      echo 'Cleaning up workspace...'
      cleanWs()
    }
  }
}
