stage('Terraform Init & Run') {
  steps {
    withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_secrets_shankar']]) {
      dir("${env.WORKSPACE}\\arj-infra\\s3") {
        bat """
          @echo on
          rem Turn on delayed expansion so variables are expanded at execution time
          setlocal EnableExtensions EnableDelayedExpansion

          rem If you don't actually need to re-set these, you can delete the next 2 lines.
          rem Using !VAR! avoids breaking on ) or & in secrets.
          set "AWS_ACCESS_KEY_ID=!AWS_ACCESS_KEY_ID!"
          set "AWS_SECRET_ACCESS_KEY=!AWS_SECRET_ACCESS_KEY!"

          rem Avoid %PATH% inside parens; use delayed expansion
          set "PATH=C:\\binaries\\terraform;!PATH!"

          echo Selected action: %TF_ACTION%

          terraform version
          terraform init -upgrade -no-color

          if /I "%TF_ACTION%"=="DESTROY" (
            echo Running plan (destroy)...
            terraform plan -destroy -no-color -input=false
            echo Destroying...
            terraform destroy -no-color -input=false -auto-approve
          ) else (
            echo Running plan (apply)...
            terraform plan -no-color -input=false
            echo Applying...
            terraform apply -no-color -input=false -auto-approve
          )
        """
      }
    }
  }
}
